<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Results | LungVision AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #00b4d8;
            --secondary: #0077b6;
            --bg-light: #f0f7ff;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.5);
            --text-dark: #1a1a2e;
            --card-shadow: 0 10px 40px -10px rgba(0, 180, 216, 0.1);
        }

        body {
            background: radial-gradient(circle at top left, #e0f2fe 0%, #f0f7ff 100%);
            color: var(--text-dark);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        .outfit {
            font-family: 'Outfit', sans-serif;
        }

        /* Glassmorphism Components */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--card-shadow);
        }

        .navbar {
            background: rgba(255, 255, 255, 0.8) !important;
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(0, 180, 216, 0.1);
        }

        /* Risk Card */
        .risk-card {
            border-radius: 32px;
            padding: 3rem;
            text-align: center;
            background: white;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s;
        }

        .risk-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: var(--risk-color, var(--primary));
        }

        .risk-score {
            font-size: 5rem;
            line-height: 1;
            font-weight: 800;
            margin: 1rem 0;
            background: linear-gradient(135deg, var(--risk-color, #333), #1a1a2e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .confidence-chip {
            background: #1a1a2e;
            color: white;
            padding: 8px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        /* Chart Section */
        .chart-dark-panel {
            background: #1a1a2e;
            color: white;
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            padding-bottom: 0px;
        }

        .chart-container-premium {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
            height: 320px;
            position: relative;
        }

        .chart-title {
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
        }

        /* Recommendation Cards */
        .rec-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            height: 100%;
            border: 1px solid rgba(0, 180, 216, 0.1);
            transition: all 0.3s;
        }

        .rec-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 180, 216, 0.1);
            border-color: var(--primary);
        }

        .btn-premium {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px rgba(0, 180, 216, 0.25);
            transition: all 0.3s;
        }

        .btn-premium:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(0, 180, 216, 0.4);
            color: white;
        }

        .risk-badge-high {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .risk-badge-med {
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .risk-badge-low {
            color: #198754;
            background: rgba(25, 135, 84, 0.1);
        }
    </style>
</head>

<body>

    <nav class="navbar sticky-top py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <div>
                    <h5 class="m-0 fw-bold outfit">Diagnostic Results</h5>
                    <span class="text-muted small">LungVision Protocol v2.5</span>
                </div>
            </div>
            <div class="d-flex gap-2">
                <a href="/download_report" class="btn btn-outline-dark btn-sm rounded-pill px-3">
                    <i class="bi bi-file-earmark-pdf me-2"></i>Download Report
                </a>
                <a href="/" class="btn btn-light btn-sm rounded-pill px-3 border">
                    <i class="bi bi-x-lg"></i>
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-5 mb-5">

        <!-- Top Section: Diagnosis & Stats -->
        <div class="row g-4 mb-5">
            <div class="col-lg-5">
                <div class="risk-card animate__animated animate__fadeInLeft" style="--risk-color: {{ diet.color }};">
                    <span
                        class="badge {{ 'bg-danger' if prediction == 'High' else 'bg-warning text-dark' if prediction == 'Medium' else 'bg-success' }} mb-2 rounded-pill px-3">
                        CLINICAL CLASSIFICATION
                    </span>
                    <h1 class="risk-score outfit">{{ prediction.upper() }} RISK</h1>
                    <div class="confidence-chip mb-4">
                        <span class="spinner-grow spinner-grow-sm text-info"></span>
                        AI Confidence: {{ confidence }}%
                    </div>

                    <div class="p-3 rounded-4 mt-3" style="background: {{ diet.bg }}; color: {{ diet.color }}">
                        <strong class="d-block mb-1 outfit text-uppercase">Immediate Protocol</strong>
                        <p class="small m-0 opacity-75">{{ diet.plain_text }}</p>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="glass-panel h-100 p-4 animate__animated animate__fadeInRight">
                    <h5 class="outfit fw-bold mb-4">Drivers of Prediction</h5>
                    <div class="d-flex flex-wrap gap-2 mb-4">
                        {% for cause in causes[:5] %}
                        <span class="badge bg-white border text-dark py-2 px-3 rounded-pill fw-normal shadow-sm">
                            {{ cause.name }} <strong class="ms-1 text-primary">{{ cause.val | int }}</strong>
                        </span>
                        {% endfor %}
                    </div>

                    <h5 class="outfit fw-bold mb-3 mt-4">Personalized Recommendations</h5>
                    <div class="row g-3">
                        {% for rec in recs[:2] %}
                        <div class="col-md-6">
                            <div class="d-flex align-items-start gap-3">
                                <i class="bi bi-check-circle-fill text-success mt-1"></i>
                                <span class="small text-muted">{{ rec | striptags }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <div class="mt-4 pt-3 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-uppercase text-muted fw-bold"
                                    style="font-size: 0.7rem;">Patient</small>
                                <div class="fw-bold">{{ patient_name }}</div>
                            </div>
                            <div class="text-end">
                                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.7rem;">Predicted
                                    Stage</small>
                                <div class="fw-bold text-primary">{{ stage }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div class="chart-dark-panel mb-5 animate__animated animate__fadeInUp">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h3 class="outfit fw-bold m-0 text-white">Live Insights Engine</h3>
                    <p class="m-0 text-white-50 small">Visualizing Neural Network Decisions</p>
                </div>
                <div class="d-none d-md-block">
                    <span class="badge border border-white text-white px-3 py-2 rounded-pill bg-transparent op-50">
                        <i class="bi bi-cpu me-2"></i>SHAP Values
                    </span>
                </div>
            </div>

            <div class="row g-4">
                <!-- Radar Chart -->
                <div class="col-md-4">
                    <div class="chart-container-premium">
                        <div class="chart-title">
                            Lifestyle Fingerprint
                            <i class="bi bi-activity"></i>
                        </div>
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>

                <!-- Waterfall Chart -->
                <div class="col-md-4">
                    <div class="chart-container-premium">
                        <div class="chart-title">
                            Risk Progression
                            <i class="bi bi-graph-up"></i>
                        </div>
                        <!-- Fallback to image if JS fails or for static view -->
                        {% if plot_url %}
                        <img src="data:image/png;base64,{{ plot_url }}"
                            class="img-fluid rounded-3 h-100 object-fit-contain w-100" alt="SHAP Analysis">
                        {% else %}
                        <canvas id="waterfallChart"></canvas>
                        {% endif %}
                    </div>
                </div>

                <!-- Bar Chart -->
                <div class="col-md-4">
                    <div class="chart-container-premium">
                        <div class="chart-title">
                            Key Determinants
                            <i class="bi bi-bar-chart-fill"></i>
                        </div>
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <small class="text-white-50" style="font-size: 0.7rem;">*Data normalized for clinical
                    visualization</small>
                <div class="pb-3"></div>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="glass-panel p-5 text-center mb-5 animate__animated animate__zoomIn">
            <h2 class="outfit fw-bold mb-3">Next Steps</h2>
            <p class="text-muted mb-4 max-w-600 mx-auto">Based on the analysis, we strongly recommend a clinical
                follow-up to validate these AI-driven findings.</p>
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="/" class="btn btn-outline-dark px-4 py-3 rounded-3 fw-bold">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>New Diagnosis
                </a>
                <a href="/consult" class="btn btn-premium">
                    <i class="bi bi-calendar-check me-2"></i>Book Specialist Consultation
                </a>
            </div>
        </div>

    </div>

    <!-- Chatbot Widget -->
    {% include 'chatbot.html' %}

    <script>
        // Chart.js Configuration
        Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.08)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        const rawData = {{ dashboard_data | safe }};

        if (rawData) {
            // 1. Radar Chart
            if (rawData.radar) {
                new Chart(document.getElementById('radarChart'), {
                    type: 'radar',
                    data: {
                        labels: rawData.radar.labels,
                        datasets: [{
                            label: 'Patient',
                            data: rawData.radar.data,
                            backgroundColor: 'rgba(0, 180, 216, 0.25)',
                            borderColor: '#00b4d8',
                            pointBackgroundColor: '#00b4d8',
                            pointBorderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { display: false, backdropColor: 'transparent' },
                                pointLabels: { font: { size: 11 } }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // 2. Bar Chart
            if (rawData.bar) {
                new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: {
                        labels: rawData.bar.labels,
                        datasets: [{
                            data: rawData.bar.data,
                            backgroundColor: rawData.bar.data.map(v => v > 0 ? '#ef476f' : '#06d6a0'),
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { grid: { display: false } }
                        }
                    }
                });
            }

            // 3. Waterfall (If plot_url is missing, we could render a JS version if data existed)
            // Currently utilizing the static image fallback for best SHAP accuracy.
        }
    </script>

    <!-- Chatbot Widget -->
    {% include 'chatbot.html' %}

</body>

</html>